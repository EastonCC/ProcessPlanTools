<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formula Editor - ProcessPlanTools</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
        background: #191919; 
        color: #e0e0e0;
        min-height: 100vh; 
    }

    /* Header */
    .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        border-bottom: 1px solid #333;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        background: #3b82f6;
        border-radius: 50%;
    }

    .header-title {
        font-size: 15px;
        font-weight: 500;
        color: #e0e0e0;
    }

    .toggle-sidebar-btn {
        background: #3b82f6;
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .toggle-sidebar-btn:hover {
        background: #2563eb;
    }

    /* Main Content */
    .main-content {
        max-width: 1100px;
        margin: 0 auto;
        padding: 32px 24px;
    }

    /* Editor Card */
    .editor-card {
        background: #232323;
        border: 1px solid #333;
        border-radius: 12px;
        overflow: hidden;
    }

    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #333;
    }

    .editor-title {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
    }

    .editor-actions {
        display: flex;
        gap: 8px;
    }

    .btn {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-secondary {
        background: #2a2a2a;
        color: #e0e0e0;
        border: 1px solid #404040;
    }

    .btn-secondary:hover {
        background: #333;
    }

    /* Code Editor */
    .code-editor {
        display: flex;
        min-height: 500px;
        max-height: 70vh;
        overflow: auto;
        background: #1a1a1a;
    }

    .line-numbers {
        padding: 16px 0;
        background: #1e1e1e;
        border-right: 1px solid #333;
        text-align: right;
        user-select: none;
        min-width: 50px;
    }

    .line-number {
        padding: 0 12px;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.6;
        color: #555;
    }

    .line-number.active {
        color: #888;
    }

    .code-area {
        flex: 1;
        position: relative;
        overflow: auto;
    }

    .code-textarea {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        padding: 16px;
        background: transparent;
        border: none;
        color: transparent;
        caret-color: #fff;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.6;
        resize: none;
        white-space: pre;
        overflow: auto;
        z-index: 2;
    }

    .code-textarea:focus {
        outline: none;
    }

    .code-highlight {
        padding: 16px;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.6;
        white-space: pre;
        pointer-events: none;
        min-height: 100%;
    }

    /* Scrollbar */
    .code-editor::-webkit-scrollbar,
    .code-textarea::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }

    .code-editor::-webkit-scrollbar-track,
    .code-textarea::-webkit-scrollbar-track {
        background: #1a1a1a;
    }

    .code-editor::-webkit-scrollbar-thumb,
    .code-textarea::-webkit-scrollbar-thumb {
        background: #444;
        border-radius: 6px;
        border: 2px solid #1a1a1a;
    }

    .code-editor::-webkit-scrollbar-thumb:hover,
    .code-textarea::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .code-editor::-webkit-scrollbar-corner {
        background: #1a1a1a;
    }

    /* Syntax Highlighting */
    .function { color: #4ade80; font-weight: 500; }
    .string { color: #f97316; }
    .number { color: #60a5fa; }
    .operator { color: #e0e0e0; }
    .parenthesis { color: #888; }
    .bracket { color: #a78bfa; }

    /* Notification */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: #22c55e;
        color: white;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s;
        pointer-events: none;
        z-index: 1001;
    }

    .notification.show {
        opacity: 1;
        transform: translateY(0);
    }

    .notification.error {
        background: #ef4444;
    }

    /* Sidebar */
    .sidebar {
        position: fixed;
        top: 0;
        right: -350px;
        width: 350px;
        height: 100vh;
        background: #232323;
        border-left: 1px solid #333;
        transition: right 0.3s ease;
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }

    .sidebar.open {
        right: 0;
    }

    .sidebar-header {
        padding: 16px 20px;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-title {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
    }

    .sidebar-close {
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .sidebar-close:hover {
        color: #fff;
    }

    .sidebar-search {
        padding: 12px 20px;
        border-bottom: 1px solid #333;
    }

    .sidebar-search input {
        width: 100%;
        padding: 10px 12px;
        background: #191919;
        border: 1px solid #404040;
        border-radius: 6px;
        color: #e0e0e0;
        font-size: 14px;
    }

    .sidebar-search input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .sidebar-search input::placeholder {
        color: #666;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
    }

    .function-item {
        border-bottom: 1px solid #2a2a2a;
    }

    .function-header {
        padding: 12px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }

    .function-header:hover {
        background: #2a2a2a;
    }

    .function-name {
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        color: #4ade80;
        font-weight: 500;
    }

    .function-arrow {
        color: #666;
        transition: transform 0.2s;
        font-size: 12px;
    }

    .function-item.open .function-arrow {
        transform: rotate(180deg);
    }

    .function-details {
        display: none;
        padding: 0 20px 16px 20px;
        background: #1a1a1a;
    }

    .function-item.open .function-details {
        display: block;
    }

    .function-syntax {
        background: #191919;
        padding: 10px 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 12px;
        color: #f97316;
        border: 1px solid #333;
    }

    .function-description {
        font-size: 13px;
        color: #888;
        line-height: 1.5;
    }

    .function-example {
        margin-top: 10px;
        padding: 10px 12px;
        background: #191919;
        border-radius: 6px;
        border: 1px solid #333;
    }

    .function-example-label {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 6px;
    }

    .function-example-code {
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 12px;
        color: #e0e0e0;
    }

    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
        z-index: 999;
    }

    .sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    /* Autocomplete Dropdown */
    .autocomplete-dropdown {
        position: absolute;
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        min-width: 200px;
    }

    .autocomplete-dropdown.show {
        display: block;
    }

    .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 13px;
        color: #4ade80;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background: #3b82f6;
        color: white;
    }

    .autocomplete-dropdown::-webkit-scrollbar {
        width: 8px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-track {
        background: #2a2a2a;
    }

    .autocomplete-dropdown::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
    }

    @media (max-width: 768px) {
        .sidebar {
            width: 100%;
            right: -100%;
        }
        .editor-header {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }
        .editor-actions {
            width: 100%;
            flex-wrap: wrap;
        }
        .btn {
            flex: 1;
            min-width: 120px;
        }
    }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="header-left">
        <div class="status-dot"></div>
        <span class="header-title">ProcessPlan Tools | Formula Editor</span>
    </div>
    <button class="toggle-sidebar-btn" onclick="toggleSidebar()">
        <span>ðŸ“š</span> Functions
    </button>
</div>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span class="sidebar-title">Function Reference</span>
        <button class="sidebar-close" onclick="toggleSidebar()">Ã—</button>
    </div>
    <div class="sidebar-search">
        <input type="text" id="functionSearch" placeholder="Search functions..." oninput="filterFunctions()">
    </div>
    <div class="sidebar-content" id="functionList">
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="editor-card">
        <div class="editor-header">
            <span class="editor-title">Formula Editor</span>
            <div class="editor-actions">
                <button class="btn btn-secondary" onclick="copyFormatted()">Copy Formatted</button>
                <button class="btn btn-secondary" onclick="copyRaw()">Copy Raw</button>
                <button class="btn btn-secondary" onclick="clearEditor()">Clear</button>
            </div>
        </div>
        <div class="code-editor" id="codeEditor">
            <div class="line-numbers" id="lineNumbers"></div>
            <div class="code-area">
                <div class="code-highlight" id="codeHighlight"></div>
                <textarea class="code-textarea" id="codeTextarea" placeholder="Paste or type your formula here..." spellcheck="false"></textarea>
                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            </div>
        </div>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
const FUNCTIONS = new Set([
    'CONTAINS','EQUALS','ANYTRUE','APPEND','BDATE','BEDATE','BENUM','BNUM','CALC','CEILING','DATEADD','DATEDIFF',
    'DATELIST','DATEPART','DATEPATTERN','DATEROUND','DATESERIAL','DATETIMEMERGE','EMAILSPLIT','ENCLOSE','FIRSTVALUE',
    'FISCALMONTH','FISCALYEAR','FLOOR','FORMAT','GTDATE','GTEDATE','GTENUM','GTNUM','HASVALUE','IF','INSTANCECOUNT',
    'INSTANCETASKCOUNT','INSTANCEUPDATE','ISCONTEXT','ISEMPTY','ISPUBLICUSER','ISTRUE','JSONENCODE','JSONEXTRACT',
    'JSONFIFO','JSONINDEX','JSONQUERY','JSONREMOVE','JSONUPDATE','LEFT','LEFTOF','LEFTOFLAST','LENGTH','LINESPLIT',
    'LISTASLINES','LISTCOUNT','LISTDIFF','LISTINDEX','LISTINTERSECT','LISTITEMAPPEND','LISTITEMCONTAINS','LISTITEMENDSWITH',
    'LISTITEMLEFT','LISTITEMLEFTOF','LISTITEMPREPEND','LISTITEMREGEX','LISTITEMRIGHT','LISTITEMRIGHTOF','LISTITEMSTARTSWITH',
    'LISTJOIN','LISTMERGE','LISTUNIQUE','LOWERCASE','LTDATE','LTEDATE','LTENUM','LTNUM','MAX','MIN','MONTH','MONTHDAY',
    'MONTHLASTDAY','NORMALIZETEXT','NOT','NUM','NUMSPLIT','PARSE','PARTITION','RANDOMNUM','REGEXFIND','REGEXWORDSONLY',
    'REMOVECHARS','REMOVEDIACRITICS','REMOVESPACES','REMOVESYMBOLS','REPLACE','RIGHT','RIGHTOF','RIGHTOFLAST','ROUND','SPLIT',
    'SUM','TABLEAVG','TABLEJSON','TABLELOOKUP','TABLESUM','TASKLOOKUP','TASKREPORT','TITLECASE','TRIM','UPPERCASE',
    'URLENCODE','WORDSPLIT','WORKDAY','YEAR','ICONTAINS','IEQUALS'
]);

const textarea = document.getElementById('codeTextarea');
const highlight = document.getElementById('codeHighlight');
const lineNumbers = document.getElementById('lineNumbers');
const codeEditor = document.getElementById('codeEditor');
const autocompleteDropdown = document.getElementById('autocompleteDropdown');

let isFormatting = false;

// Autocomplete state
let autocompleteVisible = false;
let autocompleteItems = [];
let selectedIndex = 0;
let autocompleteStart = -1;

// Sorted function list for autocomplete
const FUNCTION_LIST = Array.from(FUNCTIONS).sort();

// Get current word being typed (after =)
function getCurrentFunctionPrefix() {
    const cursorPos = textarea.selectionStart;
    const text = textarea.value.substring(0, cursorPos);
    
    // Find the last = sign and get text after it
    const lastEquals = text.lastIndexOf('=');
    if (lastEquals === -1) return null;
    
    const afterEquals = text.substring(lastEquals + 1);
    
    // Check if we're still typing the function name (only letters)
    if (/^[a-zA-Z]*$/.test(afterEquals)) {
        return { prefix: afterEquals.toUpperCase(), start: lastEquals };
    }
    
    return null;
}

// Filter and show autocomplete
function updateAutocomplete() {
    const result = getCurrentFunctionPrefix();
    
    if (result === null) {
        hideAutocomplete();
        return;
    }
    
    const { prefix, start } = result;
    autocompleteStart = start;
    
    // Filter functions that start with the prefix
    autocompleteItems = FUNCTION_LIST.filter(fn => fn.startsWith(prefix));
    
    if (autocompleteItems.length === 0) {
        hideAutocomplete();
        return;
    }
    
    selectedIndex = 0;
    renderAutocomplete();
    positionAutocomplete();
    showAutocomplete();
}

function renderAutocomplete() {
    autocompleteDropdown.innerHTML = autocompleteItems.map((item, index) => 
        `<div class="autocomplete-item${index === selectedIndex ? ' selected' : ''}" data-index="${index}" data-value="${item}">=${item}()</div>`
    ).join('');
    
    // Add click handlers
    autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach(el => {
        el.addEventListener('click', () => {
            selectAutocompleteItem(parseInt(el.dataset.index));
        });
    });
}

function positionAutocomplete() {
    // Get cursor position in textarea
    const cursorPos = textarea.selectionStart;
    
    // Create a temporary span to measure text position
    const textBeforeCursor = textarea.value.substring(0, cursorPos);
    const lines = textBeforeCursor.split('\n');
    const currentLineIndex = lines.length - 1;
    const currentLineText = lines[currentLineIndex];
    
    // Calculate position
    const lineHeight = 20.8; // Approximate line height (13px * 1.6)
    const charWidth = 7.8; // Approximate character width for monospace
    
    const top = (currentLineIndex + 1) * lineHeight + 16; // +16 for padding
    const left = currentLineText.length * charWidth + 16 + 50; // +50 for line numbers width
    
    autocompleteDropdown.style.top = `${Math.min(top, 400)}px`;
    autocompleteDropdown.style.left = `${Math.min(left, 300)}px`;
}

function showAutocomplete() {
    autocompleteDropdown.classList.add('show');
    autocompleteVisible = true;
}

function hideAutocomplete() {
    autocompleteDropdown.classList.remove('show');
    autocompleteVisible = false;
    autocompleteItems = [];
    selectedIndex = 0;
}

function selectAutocompleteItem(index) {
    if (index < 0 || index >= autocompleteItems.length) return;
    
    const selectedFunction = autocompleteItems[index];
    const cursorPos = textarea.selectionStart;
    
    // Replace from = to cursor with the selected function
    const before = textarea.value.substring(0, autocompleteStart);
    const after = textarea.value.substring(cursorPos);
    
    const insertion = `=${selectedFunction}(`;
    textarea.value = before + insertion + after;
    
    // Position cursor inside the parentheses
    const newPos = autocompleteStart + insertion.length;
    textarea.setSelectionRange(newPos, newPos);
    
    hideAutocomplete();
    updateEditor();
    textarea.focus();
}

function navigateAutocomplete(direction) {
    if (!autocompleteVisible || autocompleteItems.length === 0) return;
    
    selectedIndex += direction;
    
    if (selectedIndex < 0) selectedIndex = autocompleteItems.length - 1;
    if (selectedIndex >= autocompleteItems.length) selectedIndex = 0;
    
    renderAutocomplete();
    
    // Scroll selected item into view
    const selectedEl = autocompleteDropdown.querySelector('.autocomplete-item.selected');
    if (selectedEl) {
        selectedEl.scrollIntoView({ block: 'nearest' });
    }
}

// Format formula with indentation
function formatFormula(formula) {
    let result = '';
    let indentLevel = 0;
    const indentSize = 2;
    let bracketDepth = 0;

    for (let i = 0; i < formula.length; i++) {
        const char = formula[i];

        if (char === '[') bracketDepth++;
        if (char === ']') bracketDepth = Math.max(0, bracketDepth - 1);

        if (char === '(') {
            result += char;
            if (bracketDepth === 0) {
                indentLevel++;
                if (i + 1 < formula.length && formula[i + 1] !== ')') {
                    result += '\n' + ' '.repeat(indentLevel * indentSize);
                }
            }
        } else if (char === ')') {
            if (bracketDepth === 0) {
                indentLevel = Math.max(0, indentLevel - 1);
                if (result.trim().slice(-1) !== '(') {
                    result += '\n' + ' '.repeat(indentLevel * indentSize);
                }
            }
            result += char;
        } else if ((char === ',' || char === ';') && bracketDepth === 0) {
            result += char + '\n' + ' '.repeat(indentLevel * indentSize);
        } else if (char.match(/\s/)) {
            if (bracketDepth > 0) {
                result += char;
            }
        } else {
            result += char;
        }
    }

    return result;
}




// Tokenize for syntax highlighting
function tokenize(code) {
    const tokens = [];
    let i = 0;
    let functionDepthStack = [];

    while (i < code.length) {
        if (/\s/.test(code[i])) {
            let value = '';
            while (i < code.length && /\s/.test(code[i])) {
                value += code[i];
                i++;
            }
            tokens.push({ type: 'whitespace', value });
            continue;
        }

        if (code[i] === '"') {
            let value = '"';
            i++;
            while (i < code.length && code[i] !== '"') {
                value += code[i];
                i++;
            }
            if (i < code.length) {
                value += '"';
                i++;
            }
            tokens.push({ type: 'string', value });
            continue;
        }

        if (code[i] === "'") {
            let value = "'";
            i++;
            while (i < code.length && code[i] !== "'") {
                value += code[i];
                i++;
            }
            if (i < code.length) {
                value += "'";
                i++;
            }
            tokens.push({ type: 'string', value });
            continue;
        }

        if (/\d/.test(code[i])) {
            let value = '';
            while (i < code.length && /[\d.]/.test(code[i])) {
                value += code[i];
                i++;
            }
            tokens.push({ type: 'number', value });
            continue;
        }

        if (/[a-zA-Z_]/.test(code[i])) {
            let value = '';
            while (i < code.length && /[a-zA-Z0-9_]/.test(code[i])) {
                value += code[i];
                i++;
            }
            if (code[i] === '(' && FUNCTIONS.has(value.toUpperCase())) {
                tokens.push({ type: 'function', value: value + '(' });
                functionDepthStack.push(1);
                i++;
            } else {
                tokens.push({ type: 'identifier', value });
            }
            continue;
        }

        if (code[i] === '(') {
            for (let j = 0; j < functionDepthStack.length; j++) {
                functionDepthStack[j]++;
            }
            tokens.push({ type: 'parenthesis', value: '(' });
            i++;
            continue;
        }

        if (code[i] === ')') {
            let isClosingFunction = false;
            for (let j = functionDepthStack.length - 1; j >= 0; j--) {
                functionDepthStack[j]--;
                if (functionDepthStack[j] === 0) {
                    isClosingFunction = true;
                    functionDepthStack.splice(j, 1);
                    break;
                }
            }
            tokens.push({ type: isClosingFunction ? 'function' : 'parenthesis', value: ')' });
            i++;
            continue;
        }

        if (/[+\-*\/=<>&|;,]/.test(code[i])) {
            tokens.push({ type: 'operator', value: code[i] });
            i++;
            continue;
        }

        if (code[i] === '[' || code[i] === ']') {
            tokens.push({ type: 'bracket', value: code[i] });
            i++;
            continue;
        }

        tokens.push({ type: 'other', value: code[i] });
        i++;
    }

    return tokens;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function applySyntaxHighlighting(code) {
    const tokens = tokenize(code);
    return tokens.map(token => {
        const escaped = escapeHtml(token.value);
        switch (token.type) {
            case 'function': return `<span class="function">${escaped}</span>`;
            case 'string': return `<span class="string">${escaped}</span>`;
            case 'number': return `<span class="number">${escaped}</span>`;
            case 'operator': return `<span class="operator">${escaped}</span>`;
            case 'parenthesis': return `<span class="parenthesis">${escaped}</span>`;
            case 'bracket': return `<span class="bracket">${escaped}</span>`;
            default: return escaped;
        }
    }).join('');
}

function updateLineNumbers(code) {
    const lines = code.split('\n');
    lineNumbers.innerHTML = lines.map((_, i) => 
        `<div class="line-number">${i + 1}</div>`
    ).join('');
}

function updateEditor() {
    const code = textarea.value;
    highlight.innerHTML = applySyntaxHighlighting(code) + '\n';
    updateLineNumbers(code);
}

function formatLive() {
    const raw = textarea.value;
    const formatted = addIndentationAndSpacing(raw);
    const highlighted = applySyntaxHighlighting(formatted);
    formattedCode.innerHTML = highlighted;
}

// Handle paste - format the pasted content
textarea.addEventListener('paste', (e) => {
    e.preventDefault();
    const pastedText = e.clipboardData.getData('text');
    const formatted = formatFormula(pastedText);
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    
    textarea.value = before + formatted + after;
    
    const newPos = start + formatted.length;
    textarea.setSelectionRange(newPos, newPos);
    
    updateEditor();
    hideAutocomplete();
    showNotification('Formula formatted!');
});

// Hide autocomplete when clicking outside
document.addEventListener('click', (e) => {
    if (!autocompleteDropdown.contains(e.target) && e.target !== textarea) {
        hideAutocomplete();
    }
});

// Handle input for live updates
textarea.addEventListener('input', () => {
    updateEditor();
    updateAutocomplete();
    formatLive();
});

// Sync scroll between textarea and highlight
textarea.addEventListener('scroll', () => {
    highlight.scrollTop = textarea.scrollTop;
    highlight.scrollLeft = textarea.scrollLeft;
});

// Handle tab key
textarea.addEventListener('keydown', (e) => {
    // Handle autocomplete navigation
    if (autocompleteVisible) {
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            navigateAutocomplete(1);
            return;
        }
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            navigateAutocomplete(-1);
            return;
        }
        if (e.key === 'Enter') {
            e.preventDefault();
            selectAutocompleteItem(selectedIndex);
            return;
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            hideAutocomplete();
            return;
        }
    }
    
    // Handle Enter inside a function (after opening parenthesis)
    if (e.key === 'Enter' && !autocompleteVisible) {
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos);
        
        // Check if we're right after an opening parenthesis of a function
        const charBefore = textBefore.slice(-1);
        
        if (charBefore === '(') {
            e.preventDefault();

            const indentLevel = getIndentLevel(textBefore);
            const indentSize = 2;
            const newIndent = ' '.repeat(indentLevel * indentSize);
            const closingIndent = ' '.repeat((indentLevel - 1) * indentSize);

            // Check if a closing parenthesis already exists ahead
            const hasClosingParenAhead = /^\s*\)/.test(textAfter);

            const insertion =
                '\n' +
                newIndent +
                (hasClosingParenAhead ? '\n' + closingIndent : '\n' + closingIndent + ')');

            textarea.value = textBefore + insertion + textAfter;

            // Cursor goes on the indented line
            const newPos = cursorPos + 1 + newIndent.length;
            textarea.setSelectionRange(newPos, newPos);

            updateEditor();
            return;
        }

    }
    
    if (e.key === 'Tab') {
        e.preventDefault();
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        textarea.value = textarea.value.substring(0, start) + '  ' + textarea.value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + 2;
        updateEditor();
    }
});

// Calculate indent level based on unmatched opening parens (outside brackets)
function getIndentLevel(text) {
    let level = 0;
    let bracketDepth = 0;
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '[') bracketDepth++;
        if (char === ']') bracketDepth = Math.max(0, bracketDepth - 1);
        
        if (bracketDepth === 0) {
            if (char === '(') level++;
            if (char === ')') level = Math.max(0, level - 1);
        }
    }
    
    return level;
}

// Copy formatted (with indentation)
function copyFormatted() {
    const code = textarea.value;
    if (!code.trim()) {
        showNotification('Nothing to copy!', 'error');
        return;
    }
    navigator.clipboard.writeText(code)
        .then(() => showNotification('Copied formatted!'))
        .catch(() => showNotification('Failed to copy', 'error'));
}

// Copy raw (without formatting)
function copyRaw() {
    const code = textarea.value;
    if (!code.trim()) {
        showNotification('Nothing to copy!', 'error');
        return;
    }
    let raw = code.replace(/[\n\r\t]+/g, '');
    raw = raw.replace(/\(\s+/g, '(').replace(/\s+\)/g, ')');
    
    navigator.clipboard.writeText(raw)
        .then(() => showNotification('Copied raw!'))
        .catch(() => showNotification('Failed to copy', 'error'));
}

function clearEditor() {
    textarea.value = '';
    updateEditor();
    showNotification('Cleared!');
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification' + (type === 'error' ? ' error' : '');
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 2500);
}

// Sidebar functions
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('show');
}

// Function documentation
const FUNCTION_DOCS = [
    { name: 'ANYTRUE', syntax: '=ANYTRUE(condition1; condition2; ...)', description: 'Returns true if any of the specified conditions evaluate to true.', example: '=ANYTRUE(EQUALS([[Status]];"Complete"); EQUALS([[Status]];"Done"))' },
    { name: 'APPEND', syntax: '=APPEND(text1; text2; ...)', description: 'Combines multiple text values into one string.', example: '=APPEND([[First Name]];" ";[[Last Name]])' },
    { name: 'BDATE', syntax: '=BDATE(date; startDate; endDate)', description: 'Returns true if the date is between the start and end dates (exclusive).', example: '=BDATE([[Due Date]]; "2024-01-01"; "2024-12-31")' },
    { name: 'BEDATE', syntax: '=BEDATE(date; startDate; endDate)', description: 'Returns true if the date is between or equal to the start and end dates (inclusive).', example: '=BEDATE([[Created Date]]; [[Start]]; [[End]])' },
    { name: 'BENUM', syntax: '=BENUM(number; min; max)', description: 'Returns true if the number is between or equal to min and max (inclusive).', example: '=BENUM([[Score]]; 0; 100)' },
    { name: 'BNUM', syntax: '=BNUM(number; min; max)', description: 'Returns true if the number is between min and max (exclusive).', example: '=BNUM([[Value]]; 10; 50)' },
    { name: 'CALC', syntax: '=CALC(expression)', description: 'Evaluates a mathematical expression and returns the result.', example: '=CALC([[Price]] * [[Quantity]])' },
    { name: 'CEILING', syntax: '=CEILING(number)', description: 'Rounds a number up to the nearest integer.', example: '=CEILING([[Total]] / 10)' },
    { name: 'CONTAINS', syntax: '=CONTAINS(text; searchText)', description: 'Returns true if the text contains the search text (case-sensitive).', example: '=CONTAINS([[Description]]; "urgent")' },
    { name: 'DATEADD', syntax: '=DATEADD(date; number; unit)', description: 'Adds a specified number of time units to a date. Units: days, weeks, months, years.', example: '=DATEADD([[Start Date]]; 30; "days")' },
    { name: 'DATEDIFF', syntax: '=DATEDIFF(startDate; endDate; unit)', description: 'Returns the difference between two dates in the specified unit.', example: '=DATEDIFF([[Start]]; [[End]]; "days")' },
    { name: 'DATELIST', syntax: '=DATELIST(startDate; endDate; interval)', description: 'Generates a list of dates between start and end at the specified interval.', example: '=DATELIST([[Start]]; [[End]]; "weekly")' },
    { name: 'DATEPART', syntax: '=DATEPART(date; part)', description: 'Extracts a specific part from a date (year, month, day, hour, minute).', example: '=DATEPART([[Created Date]]; "month")' },
    { name: 'DATEPATTERN', syntax: '=DATEPATTERN(date; pattern)', description: 'Formats a date according to the specified pattern.', example: '=DATEPATTERN([[Date]]; "MM/DD/YYYY")' },
    { name: 'DATEROUND', syntax: '=DATEROUND(date; unit)', description: 'Rounds a date to the nearest specified unit.', example: '=DATEROUND([[Timestamp]]; "hour")' },
    { name: 'DATESERIAL', syntax: '=DATESERIAL(year; month; day)', description: 'Creates a date from individual year, month, and day values.', example: '=DATESERIAL(2024; 12; 25)' },
    { name: 'DATETIMEMERGE', syntax: '=DATETIMEMERGE(date; time)', description: 'Combines a date and time into a single datetime value.', example: '=DATETIMEMERGE([[Date]]; [[Time]])' },
    { name: 'EMAILSPLIT', syntax: '=EMAILSPLIT(email; part)', description: 'Extracts parts of an email address (username or domain).', example: '=EMAILSPLIT([[Email]]; "domain")' },
    { name: 'ENCLOSE', syntax: '=ENCLOSE(text; prefix; suffix)', description: 'Wraps text with a prefix and suffix.', example: '=ENCLOSE([[Name]]; "("; ")")' },
    { name: 'EQUALS', syntax: '=EQUALS(value1; value2; ...)', description: 'Returns true if all values are equal to the first value.', example: '=EQUALS([[Status]]; "Approved")' },
    { name: 'FIRSTVALUE', syntax: '=FIRSTVALUE(value1; value2; ...)', description: 'Returns the first non-empty value from the list.', example: '=FIRSTVALUE([[Preferred Name]]; [[First Name]]; "Unknown")' },
    { name: 'FISCALMONTH', syntax: '=FISCALMONTH(date; startMonth)', description: 'Returns the fiscal month number based on fiscal year start.', example: '=FISCALMONTH([[Date]]; 7)' },
    { name: 'FISCALYEAR', syntax: '=FISCALYEAR(date; startMonth)', description: 'Returns the fiscal year based on fiscal year start month.', example: '=FISCALYEAR([[Date]]; 7)' },
    { name: 'FLOOR', syntax: '=FLOOR(number)', description: 'Rounds a number down to the nearest integer.', example: '=FLOOR([[Total]] / 3)' },
    { name: 'FORMAT', syntax: '=FORMAT(value; formatString)', description: 'Formats a value according to the specified format string.', example: '=FORMAT([[Price]]; "$#,##0.00")' },
    { name: 'GTDATE', syntax: '=GTDATE(date1; date2)', description: 'Returns true if date1 is greater than (after) date2.', example: '=GTDATE([[Due Date]]; [[Today]])' },
    { name: 'GTEDATE', syntax: '=GTEDATE(date1; date2)', description: 'Returns true if date1 is greater than or equal to date2.', example: '=GTEDATE([[End Date]]; [[Start Date]])' },
    { name: 'GTENUM', syntax: '=GTENUM(number1; number2)', description: 'Returns true if number1 is greater than or equal to number2.', example: '=GTENUM([[Score]]; 70)' },
    { name: 'GTNUM', syntax: '=GTNUM(number1; number2)', description: 'Returns true if number1 is greater than number2.', example: '=GTNUM([[Total]]; 1000)' },
    { name: 'HASVALUE', syntax: '=HASVALUE(field)', description: 'Returns true if the field contains any value (not empty).', example: '=HASVALUE([[Comments]])' },
    { name: 'ICONTAINS', syntax: '=ICONTAINS(text; searchText)', description: 'Returns true if text contains searchText (case-insensitive).', example: '=ICONTAINS([[Name]]; "smith")' },
    { name: 'IEQUALS', syntax: '=IEQUALS(value1; value2)', description: 'Returns true if values are equal (case-insensitive for text).', example: '=IEQUALS([[Status]]; "approved")' },
    { name: 'IF', syntax: '=IF(condition; valueIfTrue; valueIfFalse)', description: 'Returns one value if condition is true, another if false.', example: '=IF(GTNUM([[Score]]; 70); "Pass"; "Fail")' },
    { name: 'INSTANCECOUNT', syntax: '=INSTANCECOUNT(processName; filter)', description: 'Counts process instances matching the specified criteria.', example: '=INSTANCECOUNT("Orders"; "Status=Open")' },
    { name: 'INSTANCETASKCOUNT', syntax: '=INSTANCETASKCOUNT(filter)', description: 'Counts tasks in process instances matching criteria.', example: '=INSTANCETASKCOUNT("Assigned=CurrentUser")' },
    { name: 'INSTANCEUPDATE', syntax: '=INSTANCEUPDATE(field; value)', description: 'Updates a field value in the current process instance.', example: '=INSTANCEUPDATE("Status"; "Complete")' },
    { name: 'ISCONTEXT', syntax: '=ISCONTEXT(contextName)', description: 'Returns true if currently in the specified context.', example: '=ISCONTEXT("Mobile")' },
    { name: 'ISEMPTY', syntax: '=ISEMPTY(field)', description: 'Returns true if the field is empty or has no value.', example: '=ISEMPTY([[Notes]])' },
    { name: 'ISPUBLICUSER', syntax: '=ISPUBLICUSER()', description: 'Returns true if the current user is a public (non-authenticated) user.', example: '=ISPUBLICUSER()' },
    { name: 'ISTRUE', syntax: '=ISTRUE(value)', description: 'Returns true if the value evaluates to true/yes/1.', example: '=ISTRUE([[Is Active]])' },
    { name: 'JSONENCODE', syntax: '=JSONENCODE(value)', description: 'Converts a value to a JSON-encoded string.', example: '=JSONENCODE([[Data]])' },
    { name: 'JSONEXTRACT', syntax: '=JSONEXTRACT(json; path)', description: 'Extracts a value from JSON using the specified path.', example: '=JSONEXTRACT([[Response]]; "data.name")' },
    { name: 'JSONFIFO', syntax: '=JSONFIFO(json; action; value)', description: 'Performs FIFO queue operations on JSON arrays.', example: '=JSONFIFO([[Queue]]; "push"; [[NewItem]])' },
    { name: 'JSONINDEX', syntax: '=JSONINDEX(json; index)', description: 'Gets an item from a JSON array by index.', example: '=JSONINDEX([[Items]]; 0)' },
    { name: 'JSONQUERY', syntax: '=JSONQUERY(json; query)', description: 'Queries JSON data using a query expression.', example: '=JSONQUERY([[Data]]; "items[?status==active]")' },
    { name: 'JSONREMOVE', syntax: '=JSONREMOVE(json; path)', description: 'Removes a property or item from JSON.', example: '=JSONREMOVE([[Data]]; "tempField")' },
    { name: 'JSONUPDATE', syntax: '=JSONUPDATE(json; path; value)', description: 'Updates a value in JSON at the specified path.', example: '=JSONUPDATE([[Data]]; "status"; "updated")' },
    { name: 'LEFT', syntax: '=LEFT(text; numChars)', description: 'Returns the specified number of characters from the start of text.', example: '=LEFT([[Code]]; 3)' },
    { name: 'LEFTOF', syntax: '=LEFTOF(text; delimiter)', description: 'Returns text to the left of the first occurrence of delimiter.', example: '=LEFTOF([[Email]]; "@")' },
    { name: 'LEFTOFLAST', syntax: '=LEFTOFLAST(text; delimiter)', description: 'Returns text to the left of the last occurrence of delimiter.', example: '=LEFTOFLAST([[Path]]; "/")' },
    { name: 'LENGTH', syntax: '=LENGTH(text)', description: 'Returns the number of characters in the text.', example: '=LENGTH([[Description]])' },
    { name: 'LINESPLIT', syntax: '=LINESPLIT(text; index)', description: 'Splits text by line breaks and returns the line at index.', example: '=LINESPLIT([[Address]]; 1)' },
    { name: 'LISTASLINES', syntax: '=LISTASLINES(list)', description: 'Converts a list to text with each item on a new line.', example: '=LISTASLINES([[Items]])' },
    { name: 'LISTCOUNT', syntax: '=LISTCOUNT(list)', description: 'Returns the number of items in a list.', example: '=LISTCOUNT([[Tags]])' },
    { name: 'LISTDIFF', syntax: '=LISTDIFF(list1; list2)', description: 'Returns items in list1 that are not in list2.', example: '=LISTDIFF([[All Items]]; [[Completed]])' },
    { name: 'LISTINDEX', syntax: '=LISTINDEX(list; index)', description: 'Returns the item at the specified index in a list.', example: '=LISTINDEX([[Options]]; 0)' },
    { name: 'LISTINTERSECT', syntax: '=LISTINTERSECT(list1; list2)', description: 'Returns items that appear in both lists.', example: '=LISTINTERSECT([[Skills]]; [[Required]])' },
    { name: 'LISTITEMAPPEND', syntax: '=LISTITEMAPPEND(list; text)', description: 'Appends text to each item in the list.', example: '=LISTITEMAPPEND([[Names]]; " Jr.")' },
    { name: 'LISTITEMCONTAINS', syntax: '=LISTITEMCONTAINS(list; searchText)', description: 'Returns items containing the search text.', example: '=LISTITEMCONTAINS([[Files]]; ".pdf")' },
    { name: 'LISTITEMENDSWITH', syntax: '=LISTITEMENDSWITH(list; suffix)', description: 'Returns items that end with the specified suffix.', example: '=LISTITEMENDSWITH([[Files]]; ".xlsx")' },
    { name: 'LISTITEMLEFT', syntax: '=LISTITEMLEFT(list; numChars)', description: 'Returns the left portion of each item in the list.', example: '=LISTITEMLEFT([[Codes]]; 2)' },
    { name: 'LISTITEMLEFTOF', syntax: '=LISTITEMLEFTOF(list; delimiter)', description: 'Returns text left of delimiter for each item.', example: '=LISTITEMLEFTOF([[Emails]]; "@")' },
    { name: 'LISTITEMPREPEND', syntax: '=LISTITEMPREPEND(list; text)', description: 'Prepends text to each item in the list.', example: '=LISTITEMPREPEND([[IDs]]; "ID-")' },
    { name: 'LISTITEMREGEX', syntax: '=LISTITEMREGEX(list; pattern)', description: 'Returns items matching the regex pattern.', example: '=LISTITEMREGEX([[Data]]; "^[0-9]+$")' },
    { name: 'LISTITEMRIGHT', syntax: '=LISTITEMRIGHT(list; numChars)', description: 'Returns the right portion of each item in the list.', example: '=LISTITEMRIGHT([[Files]]; 4)' },
    { name: 'LISTITEMRIGHTOF', syntax: '=LISTITEMRIGHTOF(list; delimiter)', description: 'Returns text right of delimiter for each item.', example: '=LISTITEMRIGHTOF([[Paths]]; "/")' },
    { name: 'LISTITEMSTARTSWITH', syntax: '=LISTITEMSTARTSWITH(list; prefix)', description: 'Returns items that start with the specified prefix.', example: '=LISTITEMSTARTSWITH([[Codes]]; "A")' },
    { name: 'LISTJOIN', syntax: '=LISTJOIN(list; separator)', description: 'Joins list items into text with the specified separator.', example: '=LISTJOIN([[Tags]]; ", ")' },
    { name: 'LISTMERGE', syntax: '=LISTMERGE(list1; list2; ...)', description: 'Combines multiple lists into one.', example: '=LISTMERGE([[List1]]; [[List2]])' },
    { name: 'LISTUNIQUE', syntax: '=LISTUNIQUE(list)', description: 'Returns unique items from a list (removes duplicates).', example: '=LISTUNIQUE([[AllTags]])' },
    { name: 'LOWERCASE', syntax: '=LOWERCASE(text)', description: 'Converts text to lowercase.', example: '=LOWERCASE([[Name]])' },
    { name: 'LTDATE', syntax: '=LTDATE(date1; date2)', description: 'Returns true if date1 is less than (before) date2.', example: '=LTDATE([[Created]]; [[Deadline]])' },
    { name: 'LTEDATE', syntax: '=LTEDATE(date1; date2)', description: 'Returns true if date1 is less than or equal to date2.', example: '=LTEDATE([[Start]]; [[End]])' },
    { name: 'LTENUM', syntax: '=LTENUM(number1; number2)', description: 'Returns true if number1 is less than or equal to number2.', example: '=LTENUM([[Count]]; 10)' },
    { name: 'LTNUM', syntax: '=LTNUM(number1; number2)', description: 'Returns true if number1 is less than number2.', example: '=LTNUM([[Age]]; 18)' },
    { name: 'MAX', syntax: '=MAX(value1; value2; ...)', description: 'Returns the maximum value from the provided values.', example: '=MAX([[Score1]]; [[Score2]]; [[Score3]])' },
    { name: 'MIN', syntax: '=MIN(value1; value2; ...)', description: 'Returns the minimum value from the provided values.', example: '=MIN([[Price1]]; [[Price2]])' },
    { name: 'MONTH', syntax: '=MONTH(date)', description: 'Returns the month number (1-12) from a date.', example: '=MONTH([[Created Date]])' },
    { name: 'MONTHDAY', syntax: '=MONTHDAY(date)', description: 'Returns the day of the month (1-31) from a date.', example: '=MONTHDAY([[Birthday]])' },
    { name: 'MONTHLASTDAY', syntax: '=MONTHLASTDAY(date)', description: 'Returns the last day of the month for the given date.', example: '=MONTHLASTDAY([[Invoice Date]])' },
    { name: 'NORMALIZETEXT', syntax: '=NORMALIZETEXT(text)', description: 'Normalizes text by removing extra whitespace and special characters.', example: '=NORMALIZETEXT([[Input]])' },
    { name: 'NOT', syntax: '=NOT(condition)', description: 'Returns the opposite boolean value of the condition.', example: '=NOT(ISEMPTY([[Field]]))' },
    { name: 'NUM', syntax: '=NUM(value)', description: 'Converts a value to a number.', example: '=NUM([[Quantity]])' },
    { name: 'NUMSPLIT', syntax: '=NUMSPLIT(text)', description: 'Extracts numbers from text.', example: '=NUMSPLIT("Order #12345")' },
    { name: 'PARSE', syntax: '=PARSE(text; pattern)', description: 'Parses text according to a pattern and extracts values.', example: '=PARSE([[Code]]; "{type}-{id}")' },
    { name: 'PARTITION', syntax: '=PARTITION(list; size)', description: 'Splits a list into smaller lists of the specified size.', example: '=PARTITION([[Items]]; 10)' },
    { name: 'RANDOMNUM', syntax: '=RANDOMNUM(min; max)', description: 'Generates a random number between min and max.', example: '=RANDOMNUM(1; 100)' },
    { name: 'REGEXFIND', syntax: '=REGEXFIND(text; pattern)', description: 'Finds and returns text matching the regex pattern.', example: '=REGEXFIND([[Text]]; "[0-9]+")' },
    { name: 'REGEXWORDSONLY', syntax: '=REGEXWORDSONLY(text)', description: 'Extracts only words (alphabetic characters) from text.', example: '=REGEXWORDSONLY([[Input]])' },
    { name: 'REMOVECHARS', syntax: '=REMOVECHARS(text; chars)', description: 'Removes specified characters from text.', example: '=REMOVECHARS([[Phone]]; "-() ")' },
    { name: 'REMOVEDIACRITICS', syntax: '=REMOVEDIACRITICS(text)', description: 'Removes diacritical marks (accents) from text.', example: '=REMOVEDIACRITICS("cafÃ©")' },
    { name: 'REMOVESPACES', syntax: '=REMOVESPACES(text)', description: 'Removes all spaces from text.', example: '=REMOVESPACES([[Code]])' },
    { name: 'REMOVESYMBOLS', syntax: '=REMOVESYMBOLS(text)', description: 'Removes special symbols from text, keeping letters and numbers.', example: '=REMOVESYMBOLS([[Input]])' },
    { name: 'REPLACE', syntax: '=REPLACE(text; find; replaceWith)', description: 'Replaces occurrences of find with replaceWith in text.', example: '=REPLACE([[Text]]; "old"; "new")' },
    { name: 'RIGHT', syntax: '=RIGHT(text; numChars)', description: 'Returns the specified number of characters from the end of text.', example: '=RIGHT([[Filename]]; 4)' },
    { name: 'RIGHTOF', syntax: '=RIGHTOF(text; delimiter)', description: 'Returns text to the right of the first occurrence of delimiter.', example: '=RIGHTOF([[Email]]; "@")' },
    { name: 'RIGHTOFLAST', syntax: '=RIGHTOFLAST(text; delimiter)', description: 'Returns text to the right of the last occurrence of delimiter.', example: '=RIGHTOFLAST([[Path]]; "/")' },
    { name: 'ROUND', syntax: '=ROUND(number; decimals)', description: 'Rounds a number to the specified number of decimal places.', example: '=ROUND([[Total]]; 2)' },
    { name: 'SPLIT', syntax: '=SPLIT(text; delimiter)', description: 'Splits text into a list using the specified delimiter.', example: '=SPLIT([[Tags]]; ",")' },
    { name: 'SUM', syntax: '=SUM(value1; value2; ...)', description: 'Returns the sum of all provided values.', example: '=SUM([[Item1]]; [[Item2]]; [[Item3]])' },
    { name: 'TABLEAVG', syntax: '=TABLEAVG(table; column)', description: 'Calculates the average of values in a table column.', example: '=TABLEAVG([[LineItems]]; "Price")' },
    { name: 'TABLEJSON', syntax: '=TABLEJSON(table)', description: 'Converts a table to JSON format.', example: '=TABLEJSON([[DataTable]])' },
    { name: 'TABLELOOKUP', syntax: '=TABLELOOKUP(table; keyColumn; keyValue; returnColumn)', description: 'Looks up a value in a table and returns a corresponding value.', example: '=TABLELOOKUP([[Products]]; "SKU"; [[OrderSKU]]; "Price")' },
    { name: 'TABLESUM', syntax: '=TABLESUM(table; column)', description: 'Calculates the sum of values in a table column.', example: '=TABLESUM([[LineItems]]; "Amount")' },
    { name: 'TASKLOOKUP', syntax: '=TASKLOOKUP(taskName; field)', description: 'Retrieves a field value from a specific task.', example: '=TASKLOOKUP("Approval"; "Approver")' },
    { name: 'TASKREPORT', syntax: '=TASKREPORT(filter; fields)', description: 'Generates a report of tasks matching the filter.', example: '=TASKREPORT("Status=Open"; "Name,Assigned,Due")' },
    { name: 'TITLECASE', syntax: '=TITLECASE(text)', description: 'Converts text to title case (capitalizes first letter of each word).', example: '=TITLECASE([[name]])' },
    { name: 'TRIM', syntax: '=TRIM(text)', description: 'Removes leading and trailing whitespace from text.', example: '=TRIM([[Input]])' },
    { name: 'UPPERCASE', syntax: '=UPPERCASE(text)', description: 'Converts text to uppercase.', example: '=UPPERCASE([[Code]])' },
    { name: 'URLENCODE', syntax: '=URLENCODE(text)', description: 'Encodes text for use in a URL.', example: '=URLENCODE([[Search Term]])' },
    { name: 'WORDSPLIT', syntax: '=WORDSPLIT(text; index)', description: 'Splits text by spaces and returns the word at index.', example: '=WORDSPLIT([[Full Name]]; 0)' },
    { name: 'WORKDAY', syntax: '=WORKDAY(startDate; days; holidays)', description: 'Calculates a date that is a specified number of workdays away.', example: '=WORKDAY([[Start]]; 5; [[Holidays]])' },
    { name: 'YEAR', syntax: '=YEAR(date)', description: 'Returns the year from a date.', example: '=YEAR([[Created Date]])' }
];

function renderFunctions(functions) {
    const container = document.getElementById('functionList');
    container.innerHTML = functions.map(func => `
        <div class="function-item" data-name="${func.name}">
            <div class="function-header" onclick="toggleFunction(this)">
                <span class="function-name">=${func.name}()</span>
                <span class="function-arrow">â–¼</span>
            </div>
            <div class="function-details">
                <div class="function-syntax">${escapeHtml(func.syntax)}</div>
                <div class="function-description">${func.description}</div>
                <div class="function-example">
                    <div class="function-example-label">Example</div>
                    <div class="function-example-code">${escapeHtml(func.example)}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function toggleFunction(header) {
    header.parentElement.classList.toggle('open');
}

function filterFunctions() {
    const search = document.getElementById('functionSearch').value.toLowerCase();
    const filtered = FUNCTION_DOCS.filter(func => 
        func.name.toLowerCase().includes(search) || 
        func.description.toLowerCase().includes(search)
    );
    renderFunctions(filtered);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    renderFunctions(FUNCTION_DOCS);
    updateEditor();
});
</script>
</body>
</html>
