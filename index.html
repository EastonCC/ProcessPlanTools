<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formula Formatter - ProcessPlanTools</title>
<style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; display:flex; justify-content:center; align-items:center; }
    .container { background:white; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.3); padding:40px; max-width:1200px; width:100%; }
    h1 { color:#333; margin-bottom:10px; font-size:2em; }
    .subtitle { color:#666; margin-bottom:30px; font-size:1.1em; }
    .editor-section { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
    .input-group { display:flex; flex-direction:column; }
    .input-group h2 { font-size:1.2em; color:#444; margin-bottom:10px; }
    textarea { width:100%; height:400px; padding:15px; border:2px solid #ddd; border-radius:8px; font-family:'Consolas','Monaco','Courier New',monospace; font-size:14px; resize:vertical; transition:border-color 0.3s; }
    textarea:focus { outline:none; border-color:#667eea; }
    .output-container { width:100%; height:400px; padding:15px; border:2px solid #ddd; border-radius:8px; background:#f8f8f8; overflow:auto; font-family:'Consolas','Monaco','Courier New',monospace; font-size:14px; }
    pre { margin:0; white-space:pre-wrap; word-wrap:break-word; }
    .button-group { display:flex; gap:15px; justify-content:center; }
    button { padding:12px 30px; font-size:16px; font-weight:600; border:none; border-radius:8px; cursor:pointer; transition:all 0.3s; color:white; }
    .format-btn { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
    .format-btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,0.4); }
    .copy-btn { background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%); }
    .copy-btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(245,87,108,0.4); }
    .clear-btn { background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); }
    .clear-btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(79,172,254,0.4); }
    button:active { transform:translateY(0); }
    .notification { position:fixed; top:20px; right:20px; padding:15px 25px; background:#4caf50; color:white; border-radius:8px; box-shadow:0 5px 15px rgba(0,0,0,0.2); opacity:0; transform:translateY(-20px); transition:all 0.3s; pointer-events:none; font-weight:600; }
    .notification.show { opacity:1; transform:translateY(0); }

    /* Syntax Highlighting */
    .function { color: green; font-weight:bold; }
    .string { color:#a31515; }
    .number { color:#098658; }
    .operator { color:#000; }
    .parenthesis { color:#000; font-weight:bold; }

    @media (max-width:768px){ .editor-section{ grid-template-columns:1fr; } .container{ padding:20px; } h1{ font-size:1.5em; } }
</style>
</head>
<body>
<div class="container">
    <h1>Formula Formatter</h1>
    <p class="subtitle">Format your formulas with proper indentation and syntax highlighting</p>

    <div class="editor-section">
        <div class="input-group">
            <h2>Input Formula</h2>
            <textarea id="input" placeholder="Enter your formula here..."></textarea>
        </div>

        <div class="input-group">
            <h2>Formatted Output</h2>
            <div id="output" class="output-container">
                <pre id="formatted-code"></pre>
            </div>
        </div>
    </div>

    <div class="button-group">
        <button class="format-btn" onclick="formatFormula()">Format Formula</button>
        <button class="copy-btn" onclick="copyToClipboard()">Copy to Clipboard</button>
        <button class="clear-btn" onclick="clearAll()">Clear All</button>
    </div>
</div>

<div id="notification" class="notification"></div>

<script>
let unformattedCode = '';

const FUNCTIONS = new Set([
    'CONTAINS','EQUALS','ANYTRUE','APPEND','BDATE','BEDATE','BENUM','BNUM','CALC','CEILING','DATEADD','DATEDIFF',
    'DATELIST','DATEPART','DATEPATTERN','DATEROUND','DATESERIAL','DATETIMEMERGE','EMAILSPLIT','ENCLOSE','FIRSTVALUE',
    'FISCALMONTH','FISCALYEAR','FLOOR','FORMAT','GTDATE','GTEDATE','GTENUM','GTNUM','HASVALUE','IF','INSTANCECOUNT',
    'INSTANCETASKCOUNT','INSTANCEUPDATE','ISCONTEXT','ISEMPTY','ISPUBLICUSER','ISTRUE','JSONENCODE','JSONEXTRACT',
    'JSONFIFO','JSONINDEX','JSONQUERY','JSONREMOVE','JSONUPDATE','LEFT','LEFTOF','LEFTOFLAST','LENGTH','LINESPLIT',
    'LISTASLINES','LISTCOUNT','LISTDIFF','LISTINDEX','LISTINTERSECT','LISTITEMAPPEND','LISTITEMCONTAINS','LISTITEMENDSWITH',
    'LISTITEMLEFT','LISTITEMLEFTOF','LISTITEMPREPEND','LISTITEMREGEX','LISTITEMRIGHT','LISTITEMRIGHTOF','LISTITEMSTARTSWITH',
    'LISTJOIN','LISTMERGE','LISTUNIQUE','LOWERCASE','LTDATE','LTEDATE','LTENUM','LTNUM','MAX','MIN','MONTH','MONTHDAY',
    'MONTHLASTDAY','NORMALIZETEXT','NOT','NUM','NUMSPLIT','PARSE','PARTITION','RANDOMNUM','REGEXFIND','REGEXWORDSONLY',
    'REMOVECHARS','REMOVEDIACRITICS','REMOVESPACES','REMOVESYMBOLS','REPLACE','RIGHT','RIGHTOF','RIGHTOFLAST','ROUND','SPLIT',
    'SUM','TABLEAVG','TABLEJSON','TABLELOOKUP','TABLESUM','TASKLOOKUP','TASKREPORT','TITLECASE','TRIM','UPPERCASE',
    'URLENCODE','WORDSPLIT','WORKDAY','YEAR'
]);

function formatFormula() {
    const input = document.getElementById('input').value.trim();
    if (!input) { showNotification('Please enter a formula first!', 'error'); return; }

    unformattedCode = input;
    const formatted = addIndentationAndSpacing(input);
    const highlighted = applySyntaxHighlighting(formatted);
    document.getElementById('formatted-code').innerHTML = highlighted;

    showNotification('Formula formatted successfully!', 'success');
}

function addIndentationAndSpacing(formula) {
    let result = '';
    let indentLevel = 0;
    const indentSize = 2;
    let i = 0;
    let bracketDepth = 0; // Track [[ ]] depth to preserve spaces inside

    while (i < formula.length) {
        const char = formula[i];

        // Track bracket depth for [[ ]] field references
        if (char === '[') bracketDepth++;
        if (char === ']') bracketDepth = Math.max(0, bracketDepth - 1);

        if (char === '(') {
            result += char;
            indentLevel++;
            if (i + 1 < formula.length && formula[i + 1] !== ')') result += '\n' + ' '.repeat(indentLevel * indentSize);
        } else if (char === ')') {
            indentLevel = Math.max(0, indentLevel - 1);
            if (result.trim().slice(-1) !== '(') result += '\n' + ' '.repeat(indentLevel * indentSize);
            result += char;
        } else if (char === ',' || char === ';') {
            result += char + '\n' + ' '.repeat(indentLevel * indentSize);
        } else if (char.match(/\s/)) {
            // Preserve spaces inside brackets [[ ]], collapse outside
            if (bracketDepth > 0) {
                result += char;
            }
            // Skip whitespace outside brackets
        } else {
            result += char;
        }

        i++;
    }

    return result;
}

// Token-based syntax highlighting to avoid regex conflicts
function applySyntaxHighlighting(code) {
    const tokens = tokenize(code);
    return tokens.map(token => {
        const escaped = escapeHtml(token.value);
        switch (token.type) {
            case 'function':
                return `<span class="function">${escaped}</span>`;
            case 'function-close':
                return `<span class="function">${escaped}</span>`;
            case 'string':
                return `<span class="string">${escaped}</span>`;
            case 'number':
                return `<span class="number">${escaped}</span>`;
            case 'operator':
                return `<span class="operator">${escaped}</span>`;
            case 'parenthesis':
                return `<span class="parenthesis">${escaped}</span>`;
            default:
                return escaped;
        }
    }).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function tokenize(code) {
    const tokens = [];
    let i = 0;
    let functionDepthStack = []; // Stack to track nested function parentheses

    while (i < code.length) {
        // Whitespace
        if (/\s/.test(code[i])) {
            let value = '';
            while (i < code.length && /\s/.test(code[i])) {
                value += code[i];
                i++;
            }
            tokens.push({ type: 'whitespace', value });
            continue;
        }

        // Strings (double quotes)
        if (code[i] === '"') {
            let value = '"';
            i++;
            while (i < code.length && code[i] !== '"') {
                value += code[i];
                i++;
            }
            if (i < code.length) {
                value += '"';
                i++;
            }
            tokens.push({ type: 'string', value });
            continue;
        }

        // Strings (single quotes)
        if (code[i] === "'") {
            let value = "'";
            i++;
            while (i < code.length && code[i] !== "'") {
                value += code[i];
                i++;
            }
            if (i < code.length) {
                value += "'";
                i++;
            }
            tokens.push({ type: 'string', value });
            continue;
        }

        // Numbers
        if (/\d/.test(code[i])) {
            let value = '';
            while (i < code.length && /[\d.]/.test(code[i])) {
                value += code[i];
                i++;
            }
            tokens.push({ type: 'number', value });
            continue;
        }

        // Identifiers (could be functions)
        if (/[a-zA-Z_]/.test(code[i])) {
            let value = '';
            while (i < code.length && /[a-zA-Z0-9_]/.test(code[i])) {
                value += code[i];
                i++;
            }
            // Check if followed by ( to identify as function
            if (code[i] === '(' && FUNCTIONS.has(value.toUpperCase())) {
                tokens.push({ type: 'function', value: value + '(' });
                functionDepthStack.push(1); // Start tracking this function's depth
                i++; // skip the (
            } else {
                tokens.push({ type: 'identifier', value });
            }
            continue;
        }

        // Parentheses
        if (code[i] === '(') {
            // Increment depth for all active functions
            for (let j = 0; j < functionDepthStack.length; j++) {
                functionDepthStack[j]++;
            }
            tokens.push({ type: 'parenthesis', value: '(' });
            i++;
            continue;
        }

        if (code[i] === ')') {
            // Check if this closes any function
            let isClosingFunction = false;
            for (let j = functionDepthStack.length - 1; j >= 0; j--) {
                functionDepthStack[j]--;
                if (functionDepthStack[j] === 0) {
                    // This ) closes a function
                    isClosingFunction = true;
                    functionDepthStack.splice(j, 1); // Remove from stack
                    break;
                }
            }
            
            if (isClosingFunction) {
                tokens.push({ type: 'function-close', value: ')' });
            } else {
                tokens.push({ type: 'parenthesis', value: ')' });
            }
            i++;
            continue;
        }

        // Operators
        if (/[+\-*\/=<>&|;,]/.test(code[i])) {
            tokens.push({ type: 'operator', value: code[i] });
            i++;
            continue;
        }

        // Brackets (for field references like [[...]])
        if (code[i] === '[' || code[i] === ']') {
            tokens.push({ type: 'bracket', value: code[i] });
            i++;
            continue;
        }

        // Any other character
        tokens.push({ type: 'other', value: code[i] });
        i++;
    }

    return tokens;
}

function copyToClipboard() {
    if (!unformattedCode) { showNotification('Please format a formula first!', 'error'); return; }

    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = unformattedCode;
    tempTextarea.style.position = 'fixed';
    tempTextarea.style.left = '-9999px';
    document.body.appendChild(tempTextarea);
    tempTextarea.select();
    tempTextarea.setSelectionRange(0, 99999);

    try { document.execCommand('copy'); showNotification('Copied to clipboard!', 'success'); }
    catch { navigator.clipboard.writeText(unformattedCode).then(() => showNotification('Copied to clipboard!', 'success')).catch(() => showNotification('Failed to copy to clipboard', 'error')); }

    document.body.removeChild(tempTextarea);
}

function clearAll() {
    document.getElementById('input').value = '';
    document.getElementById('formatted-code').innerHTML = '';
    unformattedCode = '';
    showNotification('Cleared all fields', 'success');
}

function showNotification(message, type='success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.background = (type==='error') ? '#f44336' : '#4caf50';
    notification.classList.add('show');
    setTimeout(()=>{ notification.classList.remove('show'); }, 3000);
}

document.getElementById('input').addEventListener('keydown', function(e){
    if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); formatFormula(); }
});
</script>
</body>
</html>
